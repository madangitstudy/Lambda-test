import json
import urllib.request
import base64
import os
from datetime import datetime, timedelta
import boto3

def lambda_handler(event, context):
    try:
        # Initialize DynamoDB resource
        dynamodb = boto3.resource('dynamodb')
        table = dynamodb.Table('VoucherDetails')

        # Retrieve vouchers from DynamoDB
        print("Retrieving data from DynamoDB...")
        retrieved_vouchers = table.scan().get('Items', [])
        print("Retrieved vouchers:", retrieved_vouchers)

        # Check if there are vouchers that need to be generated
        vouchers_to_generate = []
        for voucher in retrieved_vouchers:
            if not voucher.get('VoucherCode'):  # Check if VoucherCode is missing
                vouchers_to_generate.append(voucher)

        if not vouchers_to_generate:
            return {
                'statusCode': 200,
                'body': json.dumps({'message': 'No new vouchers to generate.'})
            }

        # Define the URL for the API
        url = "https://flairair-api.intelisystraining.ca/RESTv1/vouchers/Generate?{fields}"

        # Define the expiry date (60 days from now) and format it as 'YYYY-MM-DD HH:mm:ss'
        expiry_date = (datetime.utcnow() + timedelta(days=60)).strftime('%Y-%m-%d %H:%M:%S')

        # Process each voucher that needs to be generated
        for voucher in vouchers_to_generate:
            payload = {
                "voucherType": {
                    "href": "/voucherTypes/a%C6%92Jj2ImKybdP8tQcem2rUrd3sa66LEFx%C2%A5BLJTdx9on4=",
                    "key": os.environ['VOUCHER_KEY'],
                    "name": "Late Arrival"
                },
                "generationNumber": 2,
                "expiryDate": expiry_date,
                "available": 20,
                "reason": "Sample reason for generating this voucher",
                "bookingWindow": "none",
                "voucherValue": 60,
                "eligiblePassengers": [
                    {
                        "firstName": voucher['PassengerFirstName'],
                        "lastName": voucher['PassengerLastName'],
                        "pnr": voucher['PNR']
                    }
                ],
            }

            # Create a request object
            req = urllib.request.Request(url, data=json.dumps(payload).encode('utf-8'), method='POST')
            req.add_header('Content-Type', 'application/json')

            # Add Basic Authentication
            username = os.environ['USERNAME']
            password = os.environ['PASSWORD']
            credentials = f"{username}:{password}"
            b64_credentials = base64.b64encode(credentials.encode()).decode()
            req.add_header('Authorization', f'Basic {b64_credentials}')

            # Make the API request to generate the voucher
            try:
                with urllib.request.urlopen(req) as response:
                    response_body = response.read()
                    response_data = json.loads(response_body)

                    # Assuming the API returns the generated VoucherCode
                    voucher_code = response_data[0]['key']  # Get the key from the response
                    voucher_expiry_date = response_data[0]['expiryDate']  # Get the expiry date from the response

                    # Update the voucher in DynamoDB
                    table.update_item(
                        Key={'PNR': voucher['PNR']},  # Update using PNR as the primary key
                        UpdateExpression="SET VoucherCode = :voucherCode, VoucherExpiryDate = :expiryDate",
                        ExpressionAttributeValues={
                            ':voucherCode': voucher_code,
                            ':expiryDate': voucher_expiry_date
                        }
                    )
                    print(f"Updated voucher for PNR: {voucher['PNR']} with VoucherCode: {voucher_code}")
            except Exception as api_error:
                print(f"Error generating voucher for PNR {voucher['PNR']}: {str(api_error)}")
        
        return {
            'statusCode': 200,
            'body': json.dumps({'message': 'Vouchers processed and updated.'})
        }

    except Exception as e:
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }
