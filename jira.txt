import json
import boto3
from botocore.exceptions import ClientError

# Initialize the DynamoDB client
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('VoucherDetails')

def lambda_handler(event, context):
    # Assuming the 'ID' value is passed in the event
    pnr_value = event.get("PNR")  # Adjust based on your event structure

    if not pnr_value:
        return {
            "statusCode": 400,
            "body": json.dumps("ID value not provided in the event")
        }
    
    try:
        # Fetching the item using the correct key
        response = table.get_item(
            Key={
                'ID': pnr_value  # Make sure this matches your DynamoDB schema
            }
        )

        # Check if the item exists
        if 'Item' not in response:
            return {
                "statusCode": 404,
                "body": json.dumps("No item found with the provided ID")
            }

        item = response['Item']
        print("DynamoDB response:", item)

        # Process the item and send notification
        email = item.get('Email')
        if not email:
            print("Email not found in DynamoDB. Using dummy email for testing.")
            email = "dummy@example.com"  # Replace with a valid email if necessary

        # Create payload for Klaviyo
        payload = {
            "data": {
                "type": "event",
                "attributes": {
                    "profile": {
                        "data": {
                            "type": "profile",
                            "attributes": {
                                "email": email
                            }
                        }
                    },
                    "metric": {
                        "data": {
                            "type": "metric",
                            "attributes": {
                                "name": "OTPG voucher_email"
                            }
                        }
                    },
                    "properties": {
                        "flight_details": {
                            "actual_arrival_time": None,
                            "expected_arrival_time": None,
                            "pnr_booking_id": item['ID'],
                            "time_length_of_delay": None
                        },
                        "passengers": [
                            {
                                "first_name": item['PassengerFirstName'],
                                "last_name": item['PassengerLastName'],
                                "passenger_type": "adult",
                                "voucher": {
                                    "expiry_date": item['VoucherExpiryDate'],
                                    "unique_voucher_code": item['VoucherCode'],
                                    "voucher_value": item['VoucherValue']
                                }
                            },
                            {
                                "first_name": "Unknown",
                                "last_name": "Unknown",
                                "passenger_type": "child",
                                "voucher": {
                                    "expiry_date": None,
                                    "unique_voucher_code": None,
                                    "voucher_value": None,
                                    "message": "Passenger must be over 18 years old"
                                }
                            }
                        ]
                    }
                }
            }
        }

        # Log the payload
        print("Payload:", json.dumps(payload))

        # Call the Klaviyo notification function
        klaviyo_response = invoke_klaviyo_notifier(payload)

        return {
            "statusCode": 200,
            "body": json.dumps("Notification sent successfully.")
        }

    except ClientError as e:
        return {
            "statusCode": 500,
            "body": json.dumps(f"Error fetching voucher details: {e.response['Error']['Message']}")
        }

def invoke_klaviyo_notifier(payload):
    # Invoke the Klaviyo notifier Lambda function
    lambda_client = boto3.client('lambda')
    
    try:
        response = lambda_client.invoke(
            FunctionName='KlaviyoNotifier',  # Update this with your actual function name
            InvocationType='RequestResponse',
            Payload=json.dumps(payload)
        )

        response_payload = json.loads(response['Payload'].read())
        return response_payload

    except ClientError as e:
        print(f"Failed to send notification: {e}")
        raise

Test Event Name
test

Response
{
  "statusCode": 404,
  "body": "\"No item found with the provided ID\""
}

Function Logs
START RequestId: c02ffb38-b78b-4b49-87f2-ecf997d7ff4e Version: $LATEST
END RequestId: c02ffb38-b78b-4b49-87f2-ecf997d7ff4e
REPORT RequestId: c02ffb38-b78b-4b49-87f2-ecf997d7ff4e	Duration: 506.86 ms	Billed Duration: 507 ms	Memory Size: 128 MB	Max Memory Used: 78 MB

Request ID
c02ffb38-b78b-4b49-87f2-ecf997d7ff4e
{
  "ID": "TVUVPJ-b2eb72",
  "PNR":"TVUVPJ",
  "data": {
    "type": "event",
    "attributes": {
      "profile": {
        "data": {
          "type": "profile",
          "attributes": {
            "email": "dylanreeveswasik@gmail.com"
          }
        }
      },
      "metric": {
        "data": {
          "type": "metric",
          "attributes": {
            "name": "OTPG voucher_email"
          }
        }
      },
      "properties": {
        "flight_details": {
          "actual_arrival_time": "2023-07-26T13:00:00",
          "arrival_airport_code": "LAX",
          "arrival_city": "Los Angeles",
          "departure_airport_code": "JFK",
          "departure_city": "New York",
          "expected_arrival_time": "2023-07-26T12:00:00",
          "flight_number": "AA101",
          "flight_status": "Delayed",
          "pnr_booking_id": "ABC123",
          "time_length_of_delay": 60
        },
        "passengers": [
          {
            "first_name": "John",
            "last_name": "Doe",
            "passenger_type": "adult",
            "voucher": {
              "expiry_date": "2023-07-31",
              "unique_voucher_code": "Voucher123",
              "voucher_value": 50
            }
          },
          {
            "first_name": "Jane",
            "last_name": "Doe",
            "passenger_type": "child",
            "voucher": {
              "expiry_date": null,
              "unique_voucher_code": null,
              "voucher_value": null,
              "message": "Passenger must be over 18 years old"
            }
          }
        ]
      }
    }
  }
}
